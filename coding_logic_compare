import json
import os
import time
import pandas as pd
from google import genai
from google.colab import userdata
# We now import exactly what is needed for a single pass
from preprocessing_modelcompare import clean_raw_text, AI_CONFIG, MODEL_NAME, OUTPUT_FILE

# --- INITIALIZATION ---
client = genai.Client(api_key=userdata.get('GEMINI_API_KEY'))

with open('codebook.json', 'r') as f:
    CODEBOOK_DICT = json.load(f)

INPUT_FILE = "Test1500.csv"
SAVE_INTERVAL = 10
TOTAL_EXPECTED = 298 

SYSTEM_PROMPT = f"""
### CODEBOOK JSON:
{json.dumps(CODEBOOK_DICT, indent=2)}
"""

def code_transcript(transcript):
    """
    Standardized function that handles both clean codes and internal thoughts.
    """
    cleaned_input = clean_raw_text(transcript)
    if len(cleaned_input) < 10:
        return "Abandoned Chat | Insufficient data", ""

    coffee_reminder = "\n\n### PRECISION CHECK: Identify all distinct categories. Use 'Other' if no fit."
    
    for attempt in range(3):
        try:
            response = client.models.generate_content(
                model=MODEL_NAME,
                contents=f"{SYSTEM_PROMPT}\n\nTranscript: {cleaned_input}{coffee_reminder}",
                config=AI_CONFIG 
            )
            
            thoughts = []
            final_answer_parts = []
            
            # Logic to separate thoughts from final text
            for part in response.candidates[0].content.parts:
                if hasattr(part, 'thought') and part.thought:
                    thoughts.append(part.text)
                elif part.text:
                    final_answer_parts.append(part.text)
            
            clean_code = " ".join(final_answer_parts).replace("**", "").replace("\n", " ").strip()
            mental_process = " ".join(thoughts).replace("\n", " ").strip()
            
            return clean_code, mental_process
            
        except Exception as e:
            time.sleep(5)
    
    return "ERROR | Response failed", ""

def main():
    # 1. Load Data
    if os.path.exists(OUTPUT_FILE):
        print(f"ðŸ“‚ Resuming progress in {OUTPUT_FILE}...")
        df = pd.read_csv(OUTPUT_FILE)
    else:
        print(f"ðŸ†• Starting fresh run for {MODEL_NAME}...")
        df = pd.read_csv(INPUT_FILE)

    # 2. Ensure columns exist for this specific pass
    if 'Applied_Code_Reasoning' not in df.columns:
        df['Applied_Code_Reasoning'] = ""
    if 'AI_Thoughts' not in df.columns:
        df['AI_Thoughts'] = ""
    
    df['Applied_Code_Reasoning'] = df['Applied_Code_Reasoning'].astype(str)
    df['AI_Thoughts'] = df['AI_Thoughts'].astype(str)
   
    processed_this_session = 0
    
    try:
        for i, row in df.iterrows():
            # Skip if already successfully coded
            if pd.notnull(df.at[i, 'Applied_Code_Reasoning']) and df.at[i, 'Applied_Code_Reasoning'].strip() != "" and "ERROR" not in str(df.at[i, 'Applied_Code_Reasoning']):
                continue

            print(f"ðŸ“ [{i+1}/{len(df)}] Coding with {MODEL_NAME}...")
            
            clean_code, mental_process = code_transcript(row['Transcript'])
            
            df.at[i, 'Applied_Code_Reasoning'] = clean_code
            df.at[i, 'AI_Thoughts'] = mental_process
            
            processed_this_session += 1

            if processed_this_session % SAVE_INTERVAL == 0:
                df.to_csv(OUTPUT_FILE, index=False)
                print(f"ðŸ’¾ Checkpoint saved.")
                      
            time.sleep(1.0) 

    except KeyboardInterrupt:
        print("\nðŸ›‘ Manual stop.")
    finally:
        df.to_csv(OUTPUT_FILE, index=False)
        print(f"ðŸ Final Save Complete. Session Total: {processed_this_session}")

if __name__ == "__main__":
    main()
